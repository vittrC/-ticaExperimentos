<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Comunica√ß√£o</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <!-- Estilo Neon -->
  <style>
    body {
      margin: 0;
      background: black;
      color: #00ff9c;
      font-family: 'Courier New', Courier, monospace;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px 20px;
    }

    .container {
      max-width: 800px;
      width: 100%;
      border: 2px solid #00ff9c;
      border-radius: 12px;
      box-shadow: 0 0 20px #00ff9c;
      padding: 30px;
      background-color: rgba(0, 0, 0, 0.8);
      text-align: center;
    }

    .button {
      margin: 10px;
      padding: 12px 30px;
      font-size: 1rem;
      background: transparent;
      border: 2px solid #00ff9c;
      color: #00ff9c;
      cursor: pointer;
      border-radius: 6px;
      box-shadow: 0 0 10px #00ff9c;
      transition: 0.3s ease;
    }

    .button:hover {
      background: #00ff9c;
      color: black;
    }

    .hidden {
      display: none;
    }

    .oculto {
      display: none;
    }

    .text-display {
      font-size: 1.4rem;
      margin-bottom: 20px;
      line-height: 1.8;
      min-height: 100px;
    }

    .input-area {
      width: 100%;
      padding: 8px;
      font-size: 1.2rem;
      border: 2px solid #00ff9c;
      border-radius: 8px;
      background: black;
      color: #00ff9c;
    }

    .stats {
      margin-top: 20px;
      font-size: 1rem;
    }

    .player-list {
      text-align: left;
      margin-top: 10px;
    }

    #resultadoFinal {
      color: #00ffcc;
      font-family: 'Russo One', sans-serif;
      text-align: center;
      padding: 40px;
    }

    #ranking div {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      margin: 10px 0;
      font-size: 1.2rem;
      color: #ffffff;
      background: rgba(0, 255, 200, 0.1);
      border: 1px solid #00ffcc;
      border-radius: 10px;
      padding: 10px;
    }

    #ranking img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }

    /* Novo estilo para o cron√¥metro */
    .cronometro {
      margin: 10px 0;
      height: 20px;
      width: 100%;
      background: #222;
      border: 1px solid #00ff9c;
      border-radius: 10px;
      overflow: hidden;
    }

    .cronometro-barra {
      height: 100%;
      background: linear-gradient(90deg, #00ff9c, #00bfa6);
      width: 100%;
      transition: width 1s linear;
    }

    .feedback {
      margin-top: 10px;
      font-size: 1.1rem;
      font-weight: bold;
    }
  </style>
</head>
<body>

<!-- MENU -->
<div class="container" id="menu">
  <h1>COMUNICA√á√ÉO</h1>
  <button class="button" onclick="criarSala()">Criar Sala</button>
  <button class="button" onclick="mostrarEntrada()">Entrar em Sala</button>
  <div id="entradaSala" class="hidden">
    <input id="codigoSala" placeholder="C√≥digo da sala..." class="input-area" />
    <button class="button" onclick="entrarEmSala()">Entrar</button>
  </div>
</div>

<!-- SALA -->
<div class="container hidden" id="sala">
  <h2>Sala: <span id="salaIdTexto">...</span></h2>
  <div>Voc√™ √©: <strong><span id="nomeJogador">...</span></strong></div>
  <div class="player-list" id="jogadoresLista"></div>
  <button class="button hidden" id="comecarJogoBtn" onclick="iniciarJogo()">Come√ßar Jogo</button>
  <button class="button" onclick="voltarMenu()">Voltar ao Menu</button>
</div>

<!-- JOGO -->
<div class="container hidden" id="jogo">
  <h2>Sala: <span id="salaIdTexto2">...</span></h2>
  <div class="stats">
    Rodada: <span id="rodada">1</span>/5 |
    Pontua√ß√£o: <span id="pontuacao">0</span>
  </div>
  <div class="text-display" id="fraseDisplay"></div>
  <div class="cronometro"><div class="cronometro-barra" id="barraTempo"></div></div>
  <input type="text" class="input-area" id="entrada" placeholder="Digite aqui..." disabled />
  <div class="feedback" id="feedback"></div>
  <button class="button" onclick="voltarMenu()">Voltar ao Menu</button>
</div>

<!-- RESULTADO -->
<div id="resultadoFinal" class="container oculto">
  <h2>üèÅ Resultado Final</h2>
  <div id="ranking"></div>
  <button class="button" onclick="voltarAoMenu()">Voltar ao Menu</button>
</div>

<!-- Sons -->
<audio id="somAcerto" src="https://cdn.pixabay.com/audio/2022/03/15/audio_40523e415c.mp3"></audio>
<audio id="somErro" src="https://cdn.pixabay.com/audio/2022/03/02/audio_59ff3cd7e2.mp3"></audio>
<audio id="somFim" src="https://cdn.pixabay.com/audio/2022/10/24/audio_65e4f7d3f0.mp3"></audio>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAVZ-dvyJuGFF4fEHGjS-TrhzBmBslVwNs",
    authDomain: "curso-3-inteligencia-emocional.firebaseapp.com",
    projectId: "curso-3-inteligencia-emocional",
    storageBucket: "curso-3-inteligencia-emocional.firebasestorage.app",
    messagingSenderId: "105031303963",
    appId: "1:105031303963:web:0ecdcddc91fbb0af69c9be"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const nomeUsuario = localStorage.getItem("usuario") || "Jogador";
  const avatarUsuario = localStorage.getItem("avatar") || "img/img1.png";

  const frases = [
    "A comunica√ß√£o eficaz √© a base de qualquer rela√ß√£o bem-sucedida.",
    "Falar √© uma necessidade, escutar √© uma arte.",
    "Palavras s√£o poderosas, use-as com sabedoria.",
    "A clareza na fala evita ru√≠dos na escuta.",
    "Empatia √© entender antes de responder.",
    "O sil√™ncio tamb√©m comunica.",
    "Boas conversas geram grandes ideias.",
    "Conex√µes verdadeiras nascem de palavras sinceras.",
    "A voz calma acalma at√© o caos.",
    "Ser ouvido √© t√£o importante quanto ser entendido."
  ];

  let salaRef, salaId, host = false, jogadorId, jogadores = [], fraseAtual = "";
  let rodadaAtual = 0, pontuacao = 0, maxRodadas = 5;
  let tempoMaximo = 30; // Tempo m√°ximo por rodada em segundos
  let tempoRestante = tempoMaximo;
  let cronometroInterval;
  const somAcerto = document.getElementById("somAcerto");
  const somErro = document.getElementById("somErro");
  const somFim = document.getElementById("somFim");

  function criarSala() {
    salaId = "sala-" + Math.floor(Math.random() * 10000);
    jogadorId = nomeUsuario;
    host = true;

    db.collection("salas").doc(salaId).set({
      jogadores: [{ nome: jogadorId, avatar: avatarUsuario }],
      host: jogadorId,
      status: "esperando",
      rodada: 0,
      frase: ""
    });

    iniciarSala();
  }

  function mostrarEntrada() {
    document.getElementById("entradaSala").classList.remove("hidden");
  }

  async function entrarEmSala() {
    salaId = document.getElementById("codigoSala").value;
    if (!salaId) return alert("Digite um c√≥digo de sala!");

    const doc = await db.collection("salas").doc(salaId).get();
    if (!doc.exists) return alert("Sala n√£o encontrada!");

    jogadores = doc.data().jogadores;
    jogadorId = nomeUsuario;

    await db.collection("salas").doc(salaId).update({
      jogadores: firebase.firestore.FieldValue.arrayUnion({ nome: jogadorId, avatar: avatarUsuario })
    });

    iniciarSala();
  }

  function iniciarSala() {
    document.getElementById("menu").classList.add("hidden");
    document.getElementById("sala").classList.remove("hidden");
    document.getElementById("salaIdTexto").textContent = salaId;
    document.getElementById("nomeJogador").textContent = jogadorId;

    salaRef = db.collection("salas").doc(salaId);
    salaRef.onSnapshot(doc => {
      const data = doc.data();
      jogadores = data.jogadores;

      document.getElementById("jogadoresLista").innerHTML = "<h3>Jogadores:</h3>" +
        jogadores.map(j => `
          <div style="display: flex; align-items: center; margin: 5px 0;">
            <img src="${j.avatar}" style="width: 30px; height: 30px; border-radius: 50%; margin-right: 10px;" />
            <span>${j.nome}</span>
          </div>`).join("");

      if (host && jogadores.length > 1 && data.status === "esperando") {
        document.getElementById("comecarJogoBtn").classList.remove("hidden");
      }

      if (data.status === "jogando") {
        document.getElementById("sala").classList.add("hidden");
        document.getElementById("jogo").classList.remove("hidden");
        document.getElementById("salaIdTexto2").textContent = salaId;
        iniciarRodada(data.frase, data.rodada);
      }

      if (data.status === "finalizado") {
        document.getElementById("jogo").classList.add("hidden");
        mostrarResultadoFinal(data.jogadores);
      }
    });
  }

  function iniciarJogo() {
    const frase = frases[Math.floor(Math.random() * frases.length)];
    salaRef.update({
      status: "jogando",
      frase: frase,
      rodada: 1
    });
  }

  function iniciarRodada(frase, rodada) {
    document.getElementById("entrada").value = "";
    document.getElementById("entrada").disabled = false;
    document.getElementById("entrada").focus();
    document.getElementById("fraseDisplay").textContent = frase;
    document.getElementById("rodada").textContent = rodada;
    document.getElementById("feedback").textContent = "";
    fraseAtual = frase;
    rodadaAtual = rodada;
    
    // Configurar cron√¥metro
    tempoRestante = tempoMaximo;
    atualizarBarraTempo();
    clearInterval(cronometroInterval);
    cronometroInterval = setInterval(() => {
      tempoRestante--;
      atualizarBarraTempo();
      if (tempoRestante <= 0) fimDoTempo();
    }, 1000);
  }

  function atualizarBarraTempo() {
    const percentual = (tempoRestante / tempoMaximo) * 100;
    document.getElementById("barraTempo").style.width = percentual + "%";
  }

  function fimDoTempo() {
    clearInterval(cronometroInterval);
    document.getElementById("entrada").disabled = true;
    document.getElementById("feedback").textContent = "‚è∞ Tempo esgotado!";
    somErro.play();
    
    if (host && rodadaAtual < maxRodadas) {
      setTimeout(() => {
        const frase = frases[Math.floor(Math.random() * frases.length)];
        salaRef.update({
          rodada: rodadaAtual + 1,
          frase: frase
        });
      }, 2000);
    } else if (host && rodadaAtual >= maxRodadas) {
      salaRef.update({ status: "finalizado" });
    }
  }

  document.getElementById("entrada").addEventListener("input", () => {
    const entrada = document.getElementById("entrada").value;
    if (entrada === fraseAtual) {
      clearInterval(cronometroInterval);
      const tempoGasto = tempoMaximo - tempoRestante;
      const wpm = Math.round((fraseAtual.split(" ").length / tempoGasto) * 60);
      const pontos = Math.max(100 - tempoGasto * 2, 10) + wpm;
      pontuacao += pontos;
      document.getElementById("pontuacao").textContent = pontuacao;
      document.getElementById("feedback").textContent = `‚úÖ +${pontos} pontos | WPM: ${wpm}`;
      document.getElementById("entrada").disabled = true;
      somAcerto.play();

      // Atualizar pontua√ß√£o no servidor
      salaRef.get().then(doc => {
        const jogadores = doc.data().jogadores;
        const atualizados = jogadores.map(j =>
          j.nome === jogadorId ? { ...j, pontos: pontuacao } : j
        );
        salaRef.update({ jogadores: atualizados });
      });

      if (host && rodadaAtual < maxRodadas) {
        setTimeout(() => {
          const frase = frases[Math.floor(Math.random() * frases.length)];
          salaRef.update({
            rodada: rodadaAtual + 1,
            frase: frase
          });
        }, 2000);
      } else if (host && rodadaAtual >= maxRodadas) {
        salaRef.update({ status: "finalizado" });
      }
    }
  });

  function mostrarResultadoFinal(jogadoresPontuacao) {
    const resultadoDiv = document.getElementById("resultadoFinal");
    const rankingDiv = document.getElementById("ranking");
    const ordenado = [...jogadoresPontuacao].sort((a, b) => (b.pontos || 0) - (a.pontos || 0));

    rankingDiv.innerHTML = ordenado.map((j, i) => `
      <div>
        <strong>#${i + 1}</strong>
        <img src="${j.avatar}" alt="Avatar">
        <span>${j.nome} - ${j.pontos || 0} pts</span>
      </div>
    `).join("");

    resultadoDiv.classList.remove("oculto");
    somFim.play();
  }

  function voltarMenu() {
    location.reload();
  }

  function voltarAoMenu() {
    location.reload();
  }
</script>

</body>
</html>